name: CI/CD - Build All Components

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RUST_NIGHTLY_VERSION: nightly-2024-05-01
  CARGO_TERM_COLOR: always

jobs:
  check-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      web: ${{ steps.filter.outputs.web }}
      desktop: ${{ steps.filter.outputs.desktop }}
      server: ${{ steps.filter.outputs.server }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          core:
            - 'src/**'
            - 'Cargo.toml'
          web:
            - 'web/**'
            - 'src/**'
            - 'Cargo.toml'
          desktop:
            - 'dioxus/**'
            - 'src/**'
            - 'Cargo.toml'
          server:
            - 'server/**'
            - 'src/**'
            - 'Cargo.toml'

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ env.RUST_NIGHTLY_VERSION }}
        components: rustfmt, clippy

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          cmake \
          libssl-dev \
          libwebkit2gtk-4.0-dev \
          libgtk-3-dev \
          libsoup2.4-dev

    - name: Apply code fixes
      run: |
        sed -i 's/Label{text, hpos, width, vpos}/Label{text, hpos, width, vpos, ..}/g' server/src/main.rs
        sed -i 's/\[127, 0, 0, 1\]/\[0, 0, 0, 0\]/g' server/src/main.rs
        sed -i 's/factorial = "\^0.3"/factorial = "0.4"/' Cargo.toml

    - name: Update dependencies
      run: cargo update

    - name: Check formatting
      run: cargo fmt --all -- --check
      continue-on-error: true

    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
      continue-on-error: true

  build-core:
    name: Build Core Library
    runs-on: ubuntu-22.04
    needs: check-changes
    if: needs.check-changes.outputs.core == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          cmake \
          libssl-dev

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ env.RUST_NIGHTLY_VERSION }}

    - name: Apply code fixes
      run: |
        sed -i 's/factorial = "\^0.3"/factorial = "0.4"/' Cargo.toml

    - name: Update dependencies
      run: cargo update

    - name: Build core library
      run: cargo build --lib

    - name: Run core tests
      run: cargo test --lib
      continue-on-error: true

  build-summary:
    name: Build Summary
    needs: [lint-and-format, build-core]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Lint & Format: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Core Build: ${{ needs.build-core.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For component-specific builds, see:" >> $GITHUB_STEP_SUMMARY
        echo "- Web: workflow_dispatch on web-release.yml" >> $GITHUB_STEP_SUMMARY
        echo "- Desktop: workflow_dispatch on desktop-release.yml" >> $GITHUB_STEP_SUMMARY
