name: Create Release

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      tag_name:
        description: 'Release tag (e.g., v0.3.1-working)'
        required: true
        type: string
      release_name:
        description: 'Release name (e.g., "Working Build v0.3.1")'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # Required to create releases
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          cmake \
          libssl-dev \
          libwebkit2gtk-4.0-dev \
          libgtk-3-dev \
          libsoup2.4-dev
    
    - name: Install Rust nightly-2024-05-01
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly-2024-05-01
        targets: wasm32-unknown-unknown
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install build tools
      run: cargo install trunk wasm-bindgen-cli --locked
    
    - name: Apply code fixes
      run: |
        sed -i 's/Label{text, hpos, width, vpos}/Label{text, hpos, width, vpos, ..}/g' server/src/main.rs
        sed -i 's/factorial = "\^0.3"/factorial = "0.4"/' Cargo.toml
        sed -i 's/\[127, 0, 0, 1\]/\[0, 0, 0, 0\]/g' server/src/main.rs
        cargo update
    
    - name: Build all components
      run: |
        cargo build --release -p depict-desktop
        cargo build --release -p depict-server
        cargo build --release -p depict-web --target wasm32-unknown-unknown
        cd web && trunk build --release && cd ..
    
    - name: Create release package
      run: |
        mkdir -p depict-release/dist
        
        # Copy binaries
        cp target/release/depict-desktop depict-release/dist/
        cp target/release/depict-server depict-release/dist/
        cp -r web/dist/* depict-release/dist/
        
        # Create README
        cat > depict-release/README.txt << 'EOF'
        Depict - Working Build
        ======================
        
        This is a verified working build of depict.
        
        Components:
        - depict-desktop: Native GUI application
        - depict-server: HTTP server for web interface
        - Web assets: HTML/JS/WASM for browser interface
        
        Quick Start:
        
        1. Run the server:
           WEBROOT=./dist PORT=8000 ./dist/depict-server
        
        2. Open browser:
           http://localhost:8000
        
        3. Try example input:
           person microwave food: open, start, stop / beep : heat
           person food: eat
        
        4. Export SVG:
           Click "Export SVG" button
        
        Build Information:
        - OS: Ubuntu 22.04
        - Rust: nightly-2024-05-01
        - Commit: ${{ github.sha }}
        - Date: $(date -Iseconds)
        
        For more information, see:
        https://github.com/${{ github.repository }}
        EOF
        
        # Create run script
        cat > depict-release/run_server.sh << 'EOF'
        #!/usr/bin/env bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        echo "Starting depict server..."
        echo "Access at: http://localhost:8000"
        echo "Press Ctrl+C to stop"
        WEBROOT="$SCRIPT_DIR/dist" PORT=8000 "$SCRIPT_DIR/dist/depict-server"
        EOF
        chmod +x depict-release/run_server.sh
        
        # Create tarballs
        tar -czf depict-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz -C depict-release .
        
        # Create desktop-only tarball
        mkdir -p desktop-only
        cp target/release/depict-desktop desktop-only/
        tar -czf depict-desktop-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz -C desktop-only .
        
        # Create checksums
        sha256sum depict-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz > checksums.txt
        sha256sum depict-desktop-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz >> checksums.txt
    
    - name: Create release notes
      run: |
        cat > release_notes.md << 'EOF'
        ## Depict - Verified Working Build
        
        This release contains a fully functional build of depict with all three components:
        
        ### ðŸ“¦ What's Included
        
        - **Desktop GUI** (`depict-desktop`) - Native application with direct SVG export
        - **Server** (`depict-server`) - HTTP server for the web interface
        - **Web Interface** - Browser-based WASM application
        
        ### âœ… Verified Configuration
        
        - **OS:** Ubuntu 22.04
        - **Rust:** nightly-2024-05-01
        - **Dependencies:** webkit2gtk-4.0, cmake
        - **Build Time:** ~40 minutes
        
        ### ðŸš€ Quick Start
        
        ```bash
        # Download and extract
        tar -xzf depict-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz
        cd depict-release
        
        # Run server
        ./run_server.sh
        
        # Access at http://localhost:8000
        ```
        
        ### ðŸ“ Example Usage
        
        Try this input in the web interface:
        
        ```
        person microwave food: open, start, stop / beep : heat
        person food: eat
        ```
        
        ### ðŸ”§ Code Fixes Applied
        
        This build includes fixes for:
        - Server Label pattern missing `classes` field
        - factorial dependency version (0.3 â†’ 0.4)
        - Server binding address (127.0.0.1 â†’ 0.0.0.0)
        
        ### ðŸ“š Documentation
        
        - [Complete Build Guide](https://github.com/${{ github.repository }}/blob/main/COMPLETE_BUILD_GUIDE.md)
        - [Fork README](https://github.com/${{ github.repository }}/blob/main/README_FORK.md)
        - [Working Nightlies](https://github.com/${{ github.repository }}/blob/main/WORKING_NIGHTLIES.txt)
        
        ### âš ï¸ Known Limitations
        
        - Linux x86_64 only (Ubuntu 22.04 tested)
        - Requires webkit2gtk-4.0 for desktop GUI
        - WASM build requires nightly Rust (2024-05-01+)
        
        ### ðŸ› Issues?
        
        If you encounter problems, please open an issue with:
        - Your OS version
        - Error messages
        - Steps to reproduce
        
        ---
        
        **Build Info:**
        - Commit: `${{ github.sha }}`
        - Build Date: $(date -Iseconds)
        - Repository: https://github.com/${{ github.repository }}
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag_name }}
        name: ${{ github.event.inputs.release_name }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          depict-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz
          depict-desktop-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz
          checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸŽ‰ Release Created!
        
        **Tag:** ${{ github.event.inputs.tag_name }}
        **Name:** ${{ github.event.inputs.release_name }}
        
        ## Downloads
        
        - Complete package: \`depict-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz\`
        - Desktop only: \`depict-desktop-${{ github.event.inputs.tag_name }}-linux-x86_64.tar.gz\`
        - Checksums: \`checksums.txt\`
        
        ## Release URL
        
        https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag_name }}
        EOF
